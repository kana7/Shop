<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link href="css/bootstrap.min.css" rel="stylesheet"/>
        <link href="css/ossbo.css" rel="stylesheet" type="text/css">
        <link href="css/ossbo_box.css" rel="stylesheet" type="text/css">
        <link href="css/ossbo_services.css" rel="stylesheet" type="text/css" media="screen">
        <link href="css/ossprint.css" rel="stylesheet" type="text/css" media="print">
        <link href="http://jquery.bluechameleon.com/js/themes/redmond/jquery.ui.all.css" rel="stylesheet" type="text/css"/>
        <link href="css/silis_table_mouse_over.css" rel="stylesheet" type="text/css" media="screen">
        <link href="css/silis_datatable.css" rel="stylesheet" type="text/css">
        <link href="css/oga_context_menu.css" rel="stylesheet" type="text/css">
        <link href="css/jquery.dataTables.css" rel="stylesheet" type="text/css">
        <link href="css/hideShowColumn.css" rel="stylesheet" type="text/css">
        <style>#ui-datepicker-div {display: none;}</style>
    </head>
    <body bgcolor="#FFFFFF" class="ogaBody">
        <script>
            if ($.isFunction(parent.changeValue))
                parent.changeValue(0, 100);
        </script>
        <div class="container-fluid">
            <input type="hidden" id="table_print" value="/Scripts/sql.exe?SqlDB=stage_001&amp;Sql=oga:oga_table_print.phs&amp;xid=1427879504igffgoigimiefgkhohechmoaeijjhiiekcjbplojdgojjnahodbclb">
            <input type="hidden" id="open_file_by_name" value="/Scripts/sql.exe?SqlDB=stage_001&amp;Sql=oga:oga_open_file.phs&amp;xid=1427879504igffgoigimiefgkhohechmoaeijjhiiekcjbplojdgojjnahodbclb&amp;file_name=">	
            <input type="hidden" id="get_new_row_value" value="/Scripts/sql.exe?SqlDB=stage_001&amp;Sql=oga:oga_table_get_mouvement.phs&amp;xid=1427879504igffgoigimiefgkhohechmoaeijjhiiekcjbplojdgojjnahodbclb&amp;_JSON=1&amp;_MerchantId=1">
            <input type="hidden" id="Print_Title" value="Liste des écritures">

            <table id="postings_list_table" class="silis_data_table tableau sticky" width="100%">
                <thead>
                    <tr>
                        <th class="silis_data_table_left">Account</th>
                        <th class="silis_data_table_left">Valeur</th>
                        <th class="silis_data_table_left">Saisie</th>
                        <th class="silis_data_table_left">TVA</th>
                        <th class="silis_data_table_left">Journal</th>
                        <th class="silis_data_table_left">Reference</th>
                        <th class="silis_data_table_left">Label</th>
                        <th class="silis_data_table_right">Debit</th>
                        <th class="silis_data_table_right">Credit</th>
                    </tr>
                </thead>

                <tbody>				
                    <tr>
                        <td class="silis_data_table_left">account number</td>
                        <td class="silis_data_table_left">date value</td>
                        <td class="silis_data_table_left">date posting</td>
                        <td class="silis_data_table_left">tva</td>
                        <td class="silis_data_table_left">Journal</td>
                        <td class="silis_data_table_left">reference</td>
                        <td class="silis_data_table_left">label</td>
                        <td class="silis_data_table_right">0</td>
                        <td class="silis_data_table_right">100.22</td>
                    </tr>
                </tbody>

                <tfoot>
                    <tr class="footer_print">
                        <th colspan="8" id="local_balance" class="silis_data_table_left"></th>
                        <th class="silis_data_table_left">Debit:</th>
                        <th class="silis_data_table_right">total debit</th>
                    </tr>
                    <tr class="footer_print">
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator silis_data_table_left">Credit:</th>
                        <th class="silis_data_table_no_separator silis_data_table_right">total credit</th>
                    </tr>
                    <tr class="footer_print">
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator"></th>
                        <th class="silis_data_table_no_separator silis_data_table_left">Balance:</th>
                        <th class="silis_data_table_no_separator silis_data_table_right">total balance</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <script>
            if ($.isFunction(parent.changeValue))
            {
                parent.changeValue(-2, -2);
            }
        </script>	
        <input type="hidden" id="img_sort_default" value="/stage_001/images/sort_default.png">
        <input type="hidden" id="img_sort_up" value="/stage_001/images/sort_up.png">
        <input type="hidden" id="img_sort_down" value="/stage_001/images/sort_down.png">

        <script type="text/javascript" src="http://jquery.bluechameleon.com/js/jquery-1.11.1.min.js"></script>
        <script type="text/javascript" src="http://jquery.bluechameleon.com/js/ui-new/jquery-ui.js"></script>
        <script type="text/javascript" src="js/ossbo.js"></script>
        <script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" src="js/hideShowColumn.js"></script>
        <script type="text/javascript" src="js/oga_context_menu.js"></script>
        <script type="text/javascript" src="/stage_001/OSL/js/oga/usefull_function.js"></script>
        
       <script type="text/javascript">
            //reload_update_row
            var id_row_update = "";
            function update_row(_id_row_update, idTrans, iMouvement) {
                id_row_update = _id_row_update;
                parent.updatePostings_EXT(idTrans, iMouvement);
            }
            function reload_row() {
                if (id_row_update == "")
                    reload_page();
                else
                {
                    var tr_element = $("#" + id_row_update);
                    var id_trans = parseInt($(tr_element).attr("data-id_trans"), 10);
                    var i_mouvement = parseInt($(tr_element).attr("data-i_mouvement"), 10);
                    $.ajax({
                        type: "POST",
                        async: false,
                        dataType: "json",
                        url: $("#get_new_row_value").val(),
                        data: "_idTransaction=" + id_trans + "&_iMouvement=" + i_mouvement,
                        error: function (msg) {
                            alert("Error !: " + msg);
                        },
                        success: function (data) {
                            _ErrorCode = parseInt($.trim(data.iReturn));
                            if (_ErrorCode == 0)
                            {
                                alert("Erreur");
                            }
                            else
                            {
                                $(tr_element).find("td").eq(1).find("div").html($.trim(data._az_value_date));
                                $(tr_element).find("td").eq(4).find("div").html($.trim(data._az_journal));
                                $(tr_element).find("td").eq(5).find("div").html($.trim(data._az_ref));
                                $(tr_element).find("td").eq(7).find("div").html($.trim(data._az_label));
                            }
                        }
                    });
                }
                id_row_update = "";
            }
            //reload page function
            function reload_page() {
                parent.show_loader();
                location.reload();
            }
            //function used for sorted uk date format
            function parseDate(a) {
                var text_date = $(a).text();
                var ukDatea = text_date.split('/');
                var date = new Date(parseInt(ukDatea[2]), parseInt(ukDatea[1]) - 1, parseInt(ukDatea[0]), 12, 0, 0, 0);
                return date.getTime()
            }
            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                "date-uk-pre": function (a) {
                    return parseDate(a);
                },
                "date-uk-asc": function (a, b) {
                    a = parseDate(a);
                    b = parseDate(b);
                    return ((a < b) ? -1 : ((a > b) ? 1 : 0));
                },
                "date-uk-desc": function (a, b) {
                    a = parseDate(a);
                    b = parseDate(b);
                    return ((a < b) ? 1 : ((a > b) ? -1 : 0));
                }
            });
            // Popup management for Counter part and reconcilation
            function open_popup(az_type, az_parent, i_identifier) {
                if (az_type == "counterpart")
                {
                    if ($.isFunction(parent.show_loader))
                        parent.show_loader();
                    parent.open_transaction(az_parent, i_identifier);
                }
                else if (az_type == "reconciliation")
                {
                    if ($.isFunction(parent.show_loader))
                        parent.show_loader();
                    parent.open_reconciliation(az_parent, i_identifier);
                }
            }
            //print function
            function print_table(type, account_number) {
                var ii = 0;
                var $inputs = "";
                $inputs += "_print_type=" + type;
                if (type == "pdf")
                {// format information for PDF printing
                    $inputs += "&_page_format=LANDSCAPE";
                    $inputs += "&_az_title=" + escape($("#Print_Title").val());
                    $inputs += "&td_size_1=2.25";
                    $inputs += "&td_size_2=2.00";
                    $inputs += "&td_size_3=2.00";
                    $inputs += "&td_size_4=2.25";
                    $inputs += "&td_size_5=1.50";
                    $inputs += "&td_size_6=2.25";
                    $inputs += "&td_size_7=0.25";
                    $inputs += "&td_size_9=2.50";
                    $inputs += "&td_align_9=R";
                    $inputs += "&td_size_10=2.50";
                    $inputs += "&td_align_10=R";
                }
                //get data_table
                var data_table = $("#postings_list_table");
                //get header
                var $input_header = get_table_head(data_table);
                //get body
                var $input_body = get_table_body(data_table, type);
                $.ajax({
                    type: "POST",
                    url: $("#table_print").val(),
                    data: $inputs + $input_header + $input_body,
                    error: function (msg) {
                        alert("Error !: " + msg);
                    },
                    success: function (data) {
                        location = $("#open_file_by_name").val() + data;
                    }
                });
            }
            function get_table_head(data_table) {
                var $inputs = "&";
                $inputs += "tr_0=";
                var columns = $(data_table).dataTable().dataTableSettings[0].aoColumns;
                $.each(columns, function (i, v) {
                    if (i > 0)
                        $inputs += ";";
                    $inputs += '\"' + escape($(v.sTitle).text()) + '\"';
                });
                return $inputs;
            }
            function get_table_body(data_table, type) {
                var $inputs = "";
                var $input_foot = 0;
                var row_count = -1;
                if ($.fn.DataTable.fnIsDataTable(data_table)) {
                    var rows = $(data_table).dataTable().fnGetNodes();
                    row_count = rows.length;
                }
                if (row_count > 0)
                {
                    var ii = 0;
                    for (ii == 0; ii < row_count; ii++)
                    {
                        $inputs += "&";
                        $inputs += "tr_" + (ii + 1) + "=";
                        $(rows[ii]).find("td").each(function (index) {
                            if (index > 0)
                                $inputs += ";";
                            if (type == "pdf")
                                $inputs += '\"' + escape($(this).text()) + '\"';
                            else
                                $inputs += '\"' + escape($(this).text().replaceAll("\"", "\"\"")) + '\"';
                        });
                    }
                }
                if (type == "pdf")
                {
                    //get footer
                    $input_foot = get_table_foot(data_table, ii + 1);
                    return $inputs + $input_foot;
                }
                else
                    return $inputs;
            }
            String.prototype.replaceAll = function (find, replace) {
                var str = this;
                return str.replace(new RegExp(find.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), replace);
            };
            function get_table_foot(data_table, i_start) {
                var $inputs = "";
                var ii = i_start;
                var jj = 0;
                var i_colspan = 0;
                $(".footer_print").each(function (e) {
                    $inputs += "&";
                    $inputs += "tr_" + ii + "=";
                    $(this).find("th").each(function (index) {
                        i_colspan = parseInt($(this).attr("colspan"), 10);
                        if (i_colspan == 1)
                        {
                            if (index > 0)
                                $inputs += ";";
                            $inputs += '\"' + escape($(this).text()) + '\"';
                        }
                        else
                        {
                            for (jj = 0; jj < i_colspan; jj++)
                            {
                                if (index > 0 || jj > 0)
                                    $inputs += ";";
                                $inputs += '\"\"';
                            }
                        }
                    });
                    ii++;
                });
                return $inputs;
            }
            function datatable_manage_rows_event() {
                var data_table = $("#postings_list_table");
                var row_count = -1;
                var rows = null;
                if ($.fn.DataTable.fnIsDataTable(data_table)) {
                    rows = $(data_table).dataTable().fnGetNodes();
                    row_count = rows.length;
                }
                if (row_count > 0)
                {
                    var ii = 0;
                    for (ii = 0; ii < row_count; ii++)
                    {
                        $(rows[ii]).bind({
                            contextmenu: function (e) {
                                datatable_contexmenu(e, $(this));
                                return false;
                            },
                            click: function (e) {
                                datatable_click(e, $(this));
                            }
                        });
                    }
                }
            }
            function datatable_click(e, click_element) {
                var $row = $(click_element);
                if (e.ctrlKey === false) {
                    $(".selected").removeClass("selected");
                }
                else
                {
                    if ($row[0].tagName !== "TR")
                    {
                        alert($row[0].tagName)
                        $row = $row.parent();
                    }
                    $row.toggleClass("selected");
                }
                var f_balance = 0;
                var i_count_element = 0;
                $(".selected").each(function (e) {
                    i_count_element++;
                    f_balance = silis_float_sum(f_balance,
                            silis_string_to_float($(this).find("td").eq(9).text()),
                            silis_string_to_float($(this).find("td").eq(8).text()),
                            2);
                });
                if ($("#local_balance").length > 0)
                {
                    if (i_count_element == 0)
                        $("#local_balance").text("");
                    else
                        $("#local_balance").text("Balance des lignes selectionnées: " + silis_float_to_string(f_balance, '.', ',', 2));
                }
            }
            function datatable_contexmenu(e, click_element) {
                var id_trans = parseInt($(click_element).attr("data-id_trans"));
                var id_rec = parseInt($(click_element).attr("data-id_rec"));
                var i_mouvement = parseInt($(click_element).attr("data-i_mouvement"));
                var ana_exists = parseInt($(click_element).attr("data-ana_exists"));
                var ana_exists_ventil = parseInt($(click_element).attr("data-ana_exists_ventil"));
                var ana_exists_postings = parseInt($(click_element).attr("data-ana_exists_postings"));
                var ana_exists_postings_tmp = parseInt($(click_element).attr("data-ana_exists_postings_tmp"));
                var context_menu_div = "";
                var width = 50;
                var left = e.pageX - 2;
                var top = e.pageY - 2;
                delete_context_menu();
                context_menu_div = "<div class='jstree-classic-context' style='z-index:99999;position:absolute;left:" + left + "px;top:" + top + "px;'>";
                context_menu_div += "<ul>";
                if ("default" == "default")
                    context_menu_div += "<li><a rel='create' href='#' style='' onclick='update_row(\"" + $(click_element).attr("id") + "\"," + id_trans + "," + i_mouvement + ")'>Modifier</a></li>";
                else
                    context_menu_div += "<li><a rel='create' href='#' style='color:grey' onclick=''>Modifier</a></li>";
                //Compta analytique
                if ("default" == "default")
                {
                    if (ana_exists > 0 && ana_exists_ventil > 0)
                    {
                        if (ana_exists_postings == 0 && ana_exists_postings_tmp == 0)
                        {
                            if (1 == 0)
                            {//not used
                                context_menu_div += "<li class='vakata-separator'></li>";
                                context_menu_div += "<li><a rel='create' href='#' style='' onclick='parent.viewAnaCrea_EXT(" + id_trans + "," + i_mouvement + ")'>Créer écritures analytiques</a></li>";
                            }
                        }
                        else
                        {
                            context_menu_div += "<li class='vakata-separator'></li>";
                            context_menu_div += "<li><a rel='create' href='#' style='' onclick='parent.viewAnaCP_EXT(" + id_trans + "," + i_mouvement + ")'>Ecritures analytiques</a></li>";
                        }
                    }
                }
                context_menu_div += "<li class='vakata-separator'></li>";
                context_menu_div += "<li>";
                //context_menu_div+="<ins style='text-decoration:none;float:left;width:16px;background: url(&quot;http://cdn1.iconfinder.com/data/icons/humano2/16x16/actions/old-edit-find.png&quot;) no-repeat scroll center center transparent;'>&nbsp;</ins>";
                if ("default" == "default")
                {
                    if (id_trans > 0)
                        context_menu_div += "<a rel='create' href='#' style='' onclick='open_popup(\"counterpart\",\"counterpart\"," + id_trans + ")'>Contre partie</a>";
                    else
                        context_menu_div += "<a rel='create' href='#' style='color:grey' onclick=''>Contre partie</a>";
                }
                else if ("default" == "reconciliation")
                {
                    if (id_trans > 0)
                        context_menu_div += "<a rel='create' href='#' style='' onclick='open_popup(\"counterpart\",\"reconciliation_counterpart\"," + id_trans + ")'>Contre partie</a>";
                    else
                        context_menu_div += "<a rel='create' href='#' style='color:grey' onclick=''>Contre partie</a>";
                }
                else
                {
                    context_menu_div += "<a rel='create' href='#' style='color:grey' onclick=''>Contre partie</a>";
                }
                context_menu_div += "</li>";
                context_menu_div += "<li>";
                //context_menu_div+="<ins style='text-decoration:none;float:left;width:16px;background: url(&quot;http://cdn1.iconfinder.com/data/icons/humano2/16x16/actions/old-edit-find.png&quot;) no-repeat scroll center center transparent;'>&nbsp;</ins>";
                if ("default" == "default")
                {
                    if (id_rec > 0)
                        context_menu_div += "<a rel='create' href='#' style='' onclick='open_popup(\"reconciliation\",\"reconciliation\"," + id_rec + ")'>Réconciliation</a>";
                    else
                        context_menu_div += "<a rel='create' href='#' style='color:grey' onclick=''>Réconciliation</a>";
                }
                else if ("default" == "counterpart")
                {
                    if (id_rec > 0)
                        context_menu_div += "<a rel='create' href='#' style='' onclick='open_popup(\"reconciliation\",\"counterpart_reconciliation\"," + id_rec + ")'>Réconciliation</a>";
                    else
                        context_menu_div += "<a rel='create' href='#' style='color:grey' onclick=''>Réconciliation</a>";
                }
                else
                    context_menu_div += "<a rel='create' href='#' style='color:grey' onclick=''>Réconciliation</a>";
                context_menu_div += "</li>";
                context_menu_div += "<li class='vakata-separator'></li>";
                context_menu_div += "<li><a rel='create' href='#' style='' onclick='print_table(\"csv\",\"\");'>Export</a></li>";
                context_menu_div += "<li><a rel='create' href='#' style='' onclick='print_table(\"pdf\",\"\");'>Imprimer</a></li>";
                context_menu_div += "</ul>";
                context_menu_div += "</div>";
                $("body").append(context_menu_div);
            }
            //on page load initialisation
            $(function () {
                // Handler for .ready() called.
                $("#postings_list_table").DataTable({
                    "autoWidth": true,
                    "info": true,
                    "lengthChange": true,
                    "order": [[1, "asc"]],
                    "orderMulti": false,
                    "ordering": true,
                    "paging": true,
                    "lengthMenu": [[10, 25, 50, 100, 500], [10, 25, 50, 100, 500]],
                    "pageLength": 50,
                    "scrollY": 400,
                    "fnDrawCallback": function (oSettings) {
                    },
                    "fnInitComplete": function (oSettings, json) {
                        if ($.isFunction(parent.changeValue))
                            parent.changeValue(100, 100);
                        $(".silis_data_table").show();
                        this.fnAdjustColumnSizing();
                        datatable_manage_rows_event();
                        if ($.isFunction(parent.changeValue))
                            parent.changeValue(-1, -1);
                        if ($.isFunction(parent.hide_loader))
                            parent.hide_loader();
                    },
                    "aoColumns": [
                        {"sName": "colTitle", "sType": "string"},
                        {"sName": "colVDate", "bSortable": true, "sType": "date-uk"},
                        {"sName": "colPDate", "bSortable": true, "sType": "date-uk"},
                        {"sName": "colTVA"},
                        {"sName": "colJournal"},
                        {"sName": "colRef"},
                        {"sName": "colImg", "bSortable": false},
                        {"sName": "colLabel"},
                        {"sName": "colDebit"},
                        {"sName": "colCredit"}
                    ],
                    "language": {
                        "url": "/stage_001/OSL/datatables/silis/datatable_language_2.json"
                    }
                });
                //hide context menu on body right click
                $("body").bind("contextmenu", function (e) {
                    if (e.which == 3)//right click
                    {
                        //close previews popup
                        delete_context_menu();
                    }
                });
                //hide context menu on body click	
                $("body").bind("click", function (e) {
                    //close previews popup
                    delete_context_menu();
                });
            });
        </script>
        <script type="text/javascript" src="js/table-stickyHeader.js"></script>
    </body></html>